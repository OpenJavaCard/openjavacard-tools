<?xml version="1.0" encoding="UTF-8"?>
<project name="openjavacard-tools"
         default="build">

    <target name="ext-proguard">
        <taskdef resource="proguard/ant/task.properties"
                 classpath="/opt/proguard/lib/proguard.jar"/>
    </target>

    <target name="clean"
            description="Delete build output">
        <delete dir="build"/>
    </target>

    <target name="build"
            depends="build-jar"
            description="Build everything">
    </target>

    <target name="build-dirs"
            description="Build directories">
        <mkdir dir="build"/>
        <mkdir dir="build/classes"/>
        <mkdir dir="build/jar"/>
    </target>

    <target name="build-depend"
            depends="build-dirs"
            description="Build dependencies">
        <mkdir dir="build/classes/commons-codec"/>
        <mkdir dir="build/classes/slf4j-api"/>
        <mkdir dir="build/classes/slf4j-simple"/>
        <mkdir dir="build/classes/jcommander"/>
        <javac
                debug="on"
                includeantruntime="true"
                destdir="build/classes/commons-codec"
                srcdir="dep/commons-codec/src/main/java"/>
        <javac
                debug="on"
                includeantruntime="true"
                destdir="build/classes/slf4j-api"
                srcdir="dep/slf4j/slf4j-api/src/main/java"/>
        <javac
                debug="on"
                includeantruntime="true"
                classpath="build/classes/slf4j-api"
                destdir="build/classes/slf4j-simple"
                srcdir="dep/slf4j/slf4j-simple/src/main/java"/>
        <javac
                debug="on"
                includeantruntime="true"
                destdir="build/classes/jcommander"
                srcdir="dep/jcommander/src/main/java"/>
    </target>

    <target name="build-code"
            depends="build-depend">
        <mkdir dir="build/classes/main"/>
        <javac includeantruntime="false"
               destdir="build/classes/main"
               srcdir="src">
            <classpath>
                <pathelement path="build/classes/commons-codec"/>
                <pathelement path="build/classes/slf4j-api"/>
                <pathelement path="build/classes/slf4j-simple"/>
                <pathelement path="build/classes/jcommander"/>
            </classpath>
        </javac>
    </target>

    <target name="build-jar"
            depends="build-code">
        <jar destfile="build/jar/openjavacard-tools-plain.jar">
            <fileset dir="build/classes/commons-codec"/>
            <fileset dir="build/classes/slf4j-api"
                     excludes="org/slf4j/impl/Static*.class"/>
            <fileset dir="build/classes/slf4j-simple"/>
            <fileset dir="build/classes/jcommander"/>
            <fileset dir="build/classes/main"/>
            <manifest>
                <attribute name="Main-Class" value="better.smartcard.tool.Main"/>
            </manifest>
        </jar>
    </target>

    <target name="build-proguard"
            depends="ext-proguard,build-jar">
        <proguard>
            -verbose
            -injars build/jar/openjavacard-tools-plain.jar
            -outjars build/jar/openjavacard-tools-proguard.jar
            -printmapping build/jar/javacard-tools-proguard.map
            -libraryjars ${java.home}/lib/rt.jar
            -libraryjars ${java.home}/lib/jce.jar
            -keepattributes *Annotation*
            -keep public class better.smartcard.tool.Main {
                public static void main(java.lang.String[]);
            }
        </proguard>
    </target>

</project>
