<?xml version="1.0" encoding="UTF-8"?>
<project name="javacard-tools"
         default="build">

    <taskdef resource="proguard/ant/task.properties"
             classpath="/opt/proguard/lib/proguard.jar"/>

    <target name="clean">
        <delete dir="build"/>
    </target>

    <target name="build"
            depends="build-jar">
    </target>

    <target name="build-depend">
        <mkdir dir="build/classes"/>
        <mkdir dir="build/classes/slf4j-api"/>
        <mkdir dir="build/classes/slf4j-simple"/>
        <mkdir dir="build/classes/jcommander"/>
        <!-- Compile dependencies -->
        <javac
                debug="on"
                includeantruntime="true"
                destdir="build/classes/slf4j-api"
                srcdir="dep/slf4j/slf4j-api/src/main/java"/>
        <javac
                debug="on"
                includeantruntime="true"
                classpath="build/classes/slf4j-api"
                destdir="build/classes/slf4j-simple"
                srcdir="dep/slf4j/slf4j-simple/src/main/java"/>
        <javac
                debug="on"
                includeantruntime="true"
                destdir="build/classes/jcommander"
                srcdir="dep/jcommander/src/main/java"/>
    </target>

    <target name="build-code"
            depends="build-depend">
        <mkdir dir="build/classes"/>
        <mkdir dir="build/classes/javacard-tools"/>
        <!-- Compile our own code -->
        <javac
                debug="on"
                includeantruntime="true"
                destdir="build/classes/javacard-tools"
                srcdir="src">
            <classpath>
                <pathelement path="build/classes/slf4j-api"/>
                <pathelement path="build/classes/slf4j-simple"/>
                <pathelement path="build/classes/jcommander"/>
                <pathelement path="lib/commons-codec-1.10.jar"/>
            </classpath>
        </javac>

    </target>

    <target name="build-jar"
            depends="build-code">
        <mkdir dir="build/jar"/>
        <!-- Build the plain JAR -->
        <jar
                destfile="build/jar/javacard-tools-plain.jar">
            <zipgroupfileset dir="lib" includes="commons-codec-1.10.jar"/>
            <fileset dir="build/classes/slf4j-api"
                     excludes="org/slf4j/impl/Static*.class"/>
            <fileset dir="build/classes/slf4j-simple"/>
            <fileset dir="build/classes/jcommander"/>
            <fileset dir="build/classes/javacard-tools"/>
            <fileset dir="../../javacard/javacard-debug/build/client/classes"/>
            <manifest>
                <attribute name="Main-Class" value="better.smartcard.tool.Main"/>
            </manifest>
        </jar>
    </target>

    <target name="build-proguard"
            depends="build-jar">
        <mkdir dir="build/jar"/>
        <!-- Obfuscate using proguard -->
        <proguard>
            -verbose
            -injars build/jar/javacard-tools-plain.jar
            -outjars build/jar/javacard-tools-proguard.jar
            -printmapping build/jar/javacard-tools-proguard.map
            -libraryjars ${java.home}/lib/rt.jar
            -libraryjars ${java.home}/lib/jce.jar
            -keepattributes *Annotation*
            -keep public class better.smartcard.tool.Main {
                public static void main(java.lang.String[]);
            }
        </proguard>
    </target>

</project>
